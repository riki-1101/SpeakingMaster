<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Adjective Player</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <header id="header"></header>
    <main class="frame-app">
        <div id="card">
            <div id="english"></div>
            <div id="japanese"></div>
        </div>

        <div class="controls">
            <label>
                日本語表示まで：
                <select id="delaySelect">
                    <option value="0">0s</option>
                    <option value="2000" selected>2s</option>
                </select>
            </label>
        </div>
        <label class="video_play_pause">
            <input type="checkbox" id="PlayPause" aria-label="再生 / 一時停止">
            <span></span>
        </label>
        
        <div id="timeModal" class="modal">
            <div class="modal-content">
                <h2>学習モードを選んでください</h2>
                <label>
                    <input type="radio" name="mode" value="full" checked>
                    フル再生
                </label><br>
                <label>
                    <input type="radio" name="mode" value="shuffle">
                    フル再生（ランダム）
                </label><br>
                <label>
                    <input type="radio" name="mode" value="time">
                    時間指定（ランダム）
                </label>
                <div id="timeOption">
                    <select id="timeSelect" aria-label="時間指定">
                        <option value="60">1:00</option>
                        <option value="120">2:00</option>
                        <option value="180">3:00</option>
                        <option value="240">4:00</option>
                        <option value="300">5:00</option>
                    </select>
                </div>

                <button id="startBtn">スタート</button>
            </div>
        </div>
    </main>
    <footer id="footer"></footer>
    <script src="../js/header.js"></script>
    <script src="../js/footer.js"></script>
    <script src="../js/script.js"></script>
    <script>
        window.addEventListener("load", () => {
            modal.style.display = "flex";
        });

        const modal = document.getElementById("timeModal");
        const startBtn = document.getElementById("startBtn");
        const timeSelect = document.getElementById("timeSelect");

        // ★ 再生モード（radio button）
        const modeRadios = document.querySelectorAll('input[name="mode"]');

        const englishDiv = document.getElementById("english");
        const japaneseDiv = document.getElementById("japanese");
        const playPause = document.getElementById("PlayPause");

        let originalData = []; // ← JSONの元データ
        let data = [];         // ← 実際に再生するデータ
        let timer = null;
        let index = 0;
        let isPlaying = false;

        startBtn.disabled = true;

        /* ---------- JSON 読み込み ---------- */
        fetch(`../json/adjective.json`)
            .then(res => res.json())
            .then(json => {
                originalData = json;
                startBtn.disabled = false;
            });

        /* ---------- スタートボタン ---------- */
        startBtn.addEventListener("click", () => {
            const mode = document.querySelector('input[name="mode"]:checked').value;

            if (mode === "full") {
                // 順にフル再生
                data = [...originalData];

            } else if (mode === "shuffle") {
                // シャッフルフル再生
                data = shuffle([...originalData]);

            } else if (mode === "time") {
                // 時間指定ランダム再生
                const seconds = Number(timeSelect.value);
                const wordCount = Math.floor(seconds / 3);
                data = shuffle([...originalData]).slice(0, wordCount);
            }

            index = 0;
            modal.style.display = "none";
        });

        /* ---------- シャッフル ---------- */
        function shuffle(array) {
            return array
                .map(v => ({ v, r: Math.random() }))
                .sort((a, b) => a.r - b.r)
                .map(obj => obj.v);
        }

        /* ---------- 再生 / 停止 ---------- */
        playPause.addEventListener("change", () => {
            if (data.length === 0) {
                playPause.checked = false;
                return;
            }
            playPause.checked ? startPlayback() : pausePlayback();
        });

        function startPlayback() {
            if (isPlaying) return;
            isPlaying = true;
            showCard(index);

            timer = setInterval(() => {
                index++;
                if (index >= data.length) {
                    stopPlayback();
                    playPause.checked = false;
                    return;
                }
                showCard(index);
            }, 3000);
        }

        function pausePlayback() {
            if (!isPlaying) return;
            isPlaying = false;
            clearInterval(timer);
            timer = null;
            speechSynthesis.cancel();
        }

        function stopPlayback() {
            pausePlayback();
            index = 0;
        }

        /* ---------- 表示 ---------- */
        function showCard(i) {
            const phrase = data[i];
            englishDiv.textContent = phrase.en;
            japaneseDiv.textContent = "";
            speakEnglish(phrase.en);

            setTimeout(() => {
                japaneseDiv.textContent = phrase.ja;
            }, Number(delaySelect.value));
        }

    </script>
</body>
</html>